# 系统集成使用指南

**审计数智析 V2.0 - 长期愿景功能集成**

本指南介绍如何启用和使用新集成的长期愿景功能。

---

## 📋 目录

1. [快速开始](#快速开始)
2. [功能配置](#功能配置)
3. [使用示例](#使用示例)
4. [API文档](#api文档)
5. [故障排查](#故障排查)

---

## 🚀 快速开始

### 步骤1: 更新环境变量

复制并配置 `.env.example`:

```bash
cd packages/backend
cp .env.example .env
vim .env
```

### 步骤2: 启用功能

在 `.env` 中配置你需要的功能:

```env
# 基础功能（默认启用）
PLUGIN_ENABLED=true
RBAC_ENABLED=true
AUDIT_ENABLED=true

# 高级功能（需要额外配置）
DISTRIBUTED_ENABLED=false  # 需要Redis
AI_ENABLED=false           # 需要API Key
```

### 步骤3: 启动服务

```bash
# 使用新的V2启动文件
npm run dev:v2

# 或者直接运行
ts-node src/index.v2.ts
```

### 步骤4: 验证系统状态

```bash
curl http://localhost:3000/api/system/status
```

---

## ⚙️ 功能配置

### 1. 插件系统 ✅ (推荐开启)

**配置项**:
```env
PLUGIN_ENABLED=true
PLUGIN_DIR="./plugins"
PLUGIN_AUTO_ACTIVATE=false
```

**功能**:
- 动态加载自定义节点
- 扩展工作流能力
- 插件生命周期管理

**使用**:
```bash
# 查看插件列表
curl http://localhost:3000/api/system/plugins

# 激活插件
curl -X POST http://localhost:3000/api/system/plugins/{pluginId}/activate
```

### 2. 权限系统 ✅ (推荐开启)

**配置项**:
```env
RBAC_ENABLED=true
RBAC_DEFAULT_ROLE="user:basic"
```

**内置角色**:
- `system:admin` - 超级管理员
- `workflow:admin` - 工作流管理员
- `user:basic` - 普通用户
- `auditor` - 审计员

**功能**:
- RBAC + ABAC混合权限模型
- 细粒度权限控制
- 团队和组织管理

### 3. 审计日志 ✅ (推荐开启)

**配置项**:
```env
AUDIT_ENABLED=true
AUDIT_RETENTION_DAYS=90
AUDIT_LOG_LEVEL="all"
```

**功能**:
- 完整操作记录
- 多维度查询
- 合规性支持

### 4. AI辅助 🤖 (可选)

**配置项**:
```env
AI_ENABLED=false
AI_PROVIDER="openai"
AI_MODEL="gpt-4"
OPENAI_API_KEY="sk-..."
```

**功能**:
- 工作流智能分析
- 优化建议
- 自然语言处理

**使用**:
```bash
# AI分析工作流
curl -X POST http://localhost:3000/api/system/analyze-workflow \
  -H "Content-Type: application/json" \
  -d '{"workflow": {...}}'
```

### 5. 分布式执行 🌐 (可选)

**配置项**:
```env
DISTRIBUTED_ENABLED=false
DISTRIBUTED_IS_COORDINATOR=true
WORKER_CAPACITY=10
REDIS_URL="redis://localhost:6379"
```

**功能**:
- 多Worker并行执行
- 负载均衡
- 故障自动恢复

**使用场景**:
- 大规模数据处理
- 高并发执行需求
- 需要高可用保证的场景

---

## 💡 使用示例

### 示例1: 启用插件和权限（基础配置）

```env
# .env
PLUGIN_ENABLED=true
PLUGIN_DIR="./plugins"
RBAC_ENABLED=true
AUDIT_ENABLED=true
```

**特点**: 
- 不需要外部依赖
- 适合单机部署
- 满足大部分需求

### 示例2: 启用AI辅助（智能化）

```env
# .env
PLUGIN_ENABLED=true
RBAC_ENABLED=true
AUDIT_ENABLED=true
AI_ENABLED=true
AI_PROVIDER="openai"
OPENAI_API_KEY="sk-..."
AI_MODEL="gpt-4"
```

**特点**:
- 智能工作流分析
- 优化建议
- 自然语言交互

### 示例3: 全功能启用（生产级）

```env
# .env
# 基础功能
PLUGIN_ENABLED=true
RBAC_ENABLED=true
AUDIT_ENABLED=true

# 高级功能
AI_ENABLED=true
OPENAI_API_KEY="sk-..."

DISTRIBUTED_ENABLED=true
DISTRIBUTED_IS_COORDINATOR=true
REDIS_URL="redis://localhost:6379"
```

**特点**:
- 所有功能启用
- 需要Redis支持
- 适合生产环境

---

## 📡 API文档

### 系统状态

```bash
GET /api/system/status
```

**响应**:
```json
{
  "success": true,
  "data": {
    "healthy": true,
    "features": {
      "distributed": { "enabled": false, "status": "inactive" },
      "plugins": { "enabled": true, "count": 0 },
      "ai": { "enabled": false, "status": "inactive" },
      "rbac": { "enabled": true, "roles": 4 },
      "audit": { "enabled": true, "logs": 0 }
    },
    "performance": {
      "uptime": 120.5,
      "memory": { "used": 150, "total": 512 },
      "cpu": 0
    }
  }
}
```

### 系统统计

```bash
GET /api/system/stats
```

**响应**:
```json
{
  "success": true,
  "data": {
    "requests": 100,
    "errors": 5,
    "uptime": 3600000,
    "features": {...},
    "plugins": { "total": 3, "active": 2 }
  }
}
```

### 插件管理

```bash
# 列出插件
GET /api/system/plugins

# 激活插件
POST /api/system/plugins/:pluginId/activate
```

### AI分析

```bash
POST /api/system/analyze-workflow
Content-Type: application/json

{
  "workflow": {
    "id": "wf_123",
    "name": "Data Processing",
    "nodes": [...],
    "edges": [...]
  }
}
```

**响应**:
```json
{
  "success": true,
  "data": {
    "summary": "工作流结构良好",
    "suggestions": [
      {
        "type": "optimization",
        "severity": "medium",
        "title": "建议并行执行",
        "description": "某些节点可以并行执行以提高性能"
      }
    ],
    "riskLevel": "low",
    "confidence": 0.85
  }
}
```

---

## 🔧 故障排查

### 问题1: 系统启动失败

**症状**: 服务无法启动，报配置错误

**解决**:
```bash
# 检查配置
grep ERROR logs/app.log

# 验证环境变量
cat .env | grep ENABLED
```

### 问题2: 插件加载失败

**症状**: 插件无法加载或激活

**解决**:
```bash
# 检查插件目录
ls -la ./plugins

# 验证插件格式
cat plugins/my-plugin/plugin.json

# 查看日志
tail -f logs/app.log | grep plugin
```

### 问题3: AI功能不可用

**症状**: AI分析返回错误

**解决**:
```bash
# 检查API Key
echo $OPENAI_API_KEY

# 测试API连接
curl https://api.openai.com/v1/models \
  -H "Authorization: Bearer $OPENAI_API_KEY"
```

### 问题4: 分布式功能无法启用

**症状**: 分布式模式启动失败

**解决**:
```bash
# 检查Redis连接
redis-cli ping

# 验证Redis URL
echo $REDIS_URL

# 测试连接
redis-cli -u $REDIS_URL ping
```

---

## 📊 性能建议

### 基础配置（单机）

```env
PLUGIN_ENABLED=true      # 低开销
RBAC_ENABLED=true        # 低开销
AUDIT_ENABLED=true       # 中等开销
AI_ENABLED=false         # -
DISTRIBUTED_ENABLED=false # -
```

**资源需求**: 2核4G内存

### 智能配置（AI增强）

```env
PLUGIN_ENABLED=true
RBAC_ENABLED=true
AUDIT_ENABLED=true
AI_ENABLED=true          # 需要API调用
DISTRIBUTED_ENABLED=false
```

**资源需求**: 2核4G内存 + API配额

### 生产配置（全功能）

```env
# 全部启用
PLUGIN_ENABLED=true
RBAC_ENABLED=true
AUDIT_ENABLED=true
AI_ENABLED=true
DISTRIBUTED_ENABLED=true
```

**资源需求**: 
- Coordinator: 4核8G
- Worker (x3): 2核4G x 3
- Redis Cluster: 3主3从

---

## 🎯 最佳实践

### 1. 渐进式启用

从基础功能开始，逐步启用高级功能：

```
Stage 1: RBAC + Audit + Plugin
         ↓
Stage 2: + AI
         ↓
Stage 3: + Distributed
```

### 2. 环境隔离

不同环境使用不同配置：

- **开发环境**: 启用所有功能，便于测试
- **测试环境**: 与生产配置一致
- **生产环境**: 按需启用，优先稳定性

### 3. 监控告警

监控关键指标：

- 系统健康状态
- 功能可用性
- 性能指标
- 错误率

---

## 📚 相关文档

- [长期愿景功能实现指南](./长期愿景功能实现指南.md)
- [长期愿景功能完成总结](./长期愿景功能完成总结.md)
- [部署指南](./DEPLOYMENT.md)
- [工作流引擎使用指南](./README_WORKFLOW_ENGINE.md)

---

## 🆘 获取帮助

- GitHub Issues: https://github.com/zy6666688/SHENJI/issues
- 文档: https://docs.example.com
- 邮件: support@example.com

---

**版本**: 2.0.0  
**更新日期**: 2025年1月4日  
**维护团队**: SHENJI Team
