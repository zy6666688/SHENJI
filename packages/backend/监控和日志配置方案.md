# ç›‘æ§å’Œæ—¥å¿—é…ç½®æ–¹æ¡ˆ

**å®¡è®¡æ•°æ™ºæ V2.0 - Monitoring & Logging Configuration**

ğŸ“Š **å…¨é¢ç›‘æ§** | ğŸ“ **è¯¦ç»†æ—¥å¿—** | ğŸ”” **åŠæ—¶å‘Šè­¦**

---

## ğŸ“‹ ç›®å½•

1. [æ–¹æ¡ˆæ¦‚è¿°](#æ–¹æ¡ˆæ¦‚è¿°)
2. [æ—¥å¿—ç³»ç»Ÿ](#æ—¥å¿—ç³»ç»Ÿ)
3. [åº”ç”¨ç›‘æ§](#åº”ç”¨ç›‘æ§)
4. [æ€§èƒ½ç›‘æ§](#æ€§èƒ½ç›‘æ§)
5. [å‘Šè­¦é…ç½®](#å‘Šè­¦é…ç½®)
6. [å®æ–½æ­¥éª¤](#å®æ–½æ­¥éª¤)

---

## ğŸ¯ æ–¹æ¡ˆæ¦‚è¿°

### ç›‘æ§ç›®æ ‡

- âœ… **åº”ç”¨å¥åº·**: å®æ—¶ç›‘æ§åº”ç”¨çŠ¶æ€
- âœ… **æ€§èƒ½æŒ‡æ ‡**: CPUã€å†…å­˜ã€å“åº”æ—¶é—´
- âœ… **é”™è¯¯è¿½è¸ª**: æ•è·å’Œåˆ†æé”™è¯¯
- âœ… **ä¸šåŠ¡æŒ‡æ ‡**: å·¥ä½œæµæ‰§è¡Œã€ç”¨æˆ·æ´»åŠ¨
- âœ… **èµ„æºä½¿ç”¨**: æ•°æ®åº“ã€Redisç­‰

### æŠ€æœ¯æ ˆ

| ç»„ä»¶ | æŠ€æœ¯é€‰å‹ | ç”¨é€” |
|------|---------|------|
| **æ—¥å¿—æ”¶é›†** | Winston | åº”ç”¨æ—¥å¿— |
| **æ—¥å¿—å­˜å‚¨** | File + å¯é€‰ELK | æ—¥å¿—æŒä¹…åŒ– |
| **åº”ç”¨ç›‘æ§** | PM2 + è‡ªå®šä¹‰ | è¿›ç¨‹ç›‘æ§ |
| **æ€§èƒ½ç›‘æ§** | Node.js Metrics | æ€§èƒ½æŒ‡æ ‡ |
| **å‘Šè­¦** | è‡ªå®šä¹‰ +å¯é€‰ç¬¬ä¸‰æ–¹ | å‘Šè­¦é€šçŸ¥ |

---

## ğŸ“ æ—¥å¿—ç³»ç»Ÿ

### 1. Winstonæ—¥å¿—é…ç½®

å®‰è£…ä¾èµ–ï¼š

```bash
npm install winston winston-daily-rotate-file
```

åˆ›å»ºæ—¥å¿—é…ç½®æ–‡ä»¶ `src/config/logger.ts`:

```typescript
import winston from 'winston';
import DailyRotateFile from 'winston-daily-rotate-file';
import path from 'path';

// æ—¥å¿—çº§åˆ«
const levels = {
  error: 0,
  warn: 1,
  info: 2,
  http: 3,
  debug: 4,
};

// æ—¥å¿—é¢œè‰²
const colors = {
  error: 'red',
  warn: 'yellow',
  info: 'green',
  http: 'magenta',
  debug: 'blue',
};

winston.addColors(colors);

// æ—¥å¿—æ ¼å¼
const format = winston.format.combine(
  winston.format.timestamp({ format: 'YYYY-MM-DD HH:mm:ss' }),
  winston.format.errors({ stack: true }),
  winston.format.splat(),
  winston.format.json()
);

// æ§åˆ¶å°æ ¼å¼ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
const consoleFormat = winston.format.combine(
  winston.format.colorize({ all: true }),
  winston.format.printf(
    (info) => `${info.timestamp} ${info.level}: ${info.message}`
  )
);

// æ—¥å¿—ç›®å½•
const logDir = path.join(__dirname, '../../logs');

// åˆ›å»ºlogger
const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || 'info',
  levels,
  format,
  transports: [
    // é”™è¯¯æ—¥å¿—æ–‡ä»¶
    new DailyRotateFile({
      filename: path.join(logDir, 'error-%DATE%.log'),
      datePattern: 'YYYY-MM-DD',
      level: 'error',
      maxSize: '20m',
      maxFiles: '30d',
      zippedArchive: true,
    }),
    
    // ç»¼åˆæ—¥å¿—æ–‡ä»¶
    new DailyRotateFile({
      filename: path.join(logDir, 'combined-%DATE%.log'),
      datePattern: 'YYYY-MM-DD',
      maxSize: '20m',
      maxFiles: '14d',
      zippedArchive: true,
    }),
    
    // HTTPæ—¥å¿—
    new DailyRotateFile({
      filename: path.join(logDir, 'http-%DATE%.log'),
      datePattern: 'YYYY-MM-DD',
      level: 'http',
      maxSize: '20m',
      maxFiles: '7d',
      zippedArchive: true,
    }),
  ],
});

// å¼€å‘ç¯å¢ƒæ·»åŠ æ§åˆ¶å°è¾“å‡º
if (process.env.NODE_ENV !== 'production') {
  logger.add(
    new winston.transports.Console({
      format: consoleFormat,
    })
  );
}

export default logger;
```

### 2. HTTPè¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶

åˆ›å»º `src/middleware/httpLogger.ts`:

```typescript
import { Request, Response, NextFunction } from 'express';
import logger from '../config/logger';

export const httpLogger = (req: Request, res: Response, next: NextFunction) => {
  const startTime = Date.now();
  
  // å“åº”å®Œæˆæ—¶è®°å½•æ—¥å¿—
  res.on('finish', () => {
    const duration = Date.now() - startTime;
    const logData = {
      method: req.method,
      url: req.originalUrl,
      status: res.statusCode,
      duration: `${duration}ms`,
      ip: req.ip,
      userAgent: req.get('user-agent'),
    };
    
    if (res.statusCode >= 400) {
      logger.warn('HTTP Request', logData);
    } else {
      logger.http('HTTP Request', logData);
    }
  });
  
  next();
};
```

### 3. é”™è¯¯æ—¥å¿—ä¸­é—´ä»¶

åˆ›å»º `src/middleware/errorLogger.ts`:

```typescript
import { Request, Response, NextFunction } from 'express';
import logger from '../config/logger';

export const errorLogger = (
  err: Error,
  req: Request,
  res: Response,
  next: NextFunction
) => {
  logger.error('Application Error', {
    error: err.message,
    stack: err.stack,
    method: req.method,
    url: req.originalUrl,
    ip: req.ip,
    body: req.body,
  });
  
  next(err);
};
```

### 4. æ—¥å¿—ä½¿ç”¨ç¤ºä¾‹

```typescript
import logger from './config/logger';

// ä¿¡æ¯æ—¥å¿—
logger.info('User logged in', { userId: 'user123', email: 'user@example.com' });

// è­¦å‘Šæ—¥å¿—
logger.warn('Rate limit approaching', { userId: 'user123', requests: 95 });

// é”™è¯¯æ—¥å¿—
logger.error('Database connection failed', { 
  error: error.message,
  attempts: 3
});

// è°ƒè¯•æ—¥å¿—
logger.debug('Cache hit', { key: 'workflow:123' });
```

### 5. æ—¥å¿—é…ç½®å»ºè®®

åœ¨ `.env` æ–‡ä»¶ä¸­æ·»åŠ :

```env
# æ—¥å¿—çº§åˆ«: error, warn, info, http, debug
LOG_LEVEL=info

# ç”Ÿäº§ç¯å¢ƒ
# LOG_LEVEL=warn
```

---

## ğŸ“Š åº”ç”¨ç›‘æ§

### 1. PM2ç›‘æ§é…ç½®

åˆ›å»º `ecosystem.config.js`:

```javascript
module.exports = {
  apps: [{
    name: 'audit-backend',
    script: 'dist/index.v2.js',
    instances: 4,  // é›†ç¾¤æ¨¡å¼ï¼Œ4ä¸ªå®ä¾‹
    exec_mode: 'cluster',
    
    // ç¯å¢ƒå˜é‡
    env: {
      NODE_ENV: 'production',
      PORT: 3000,
    },
    
    // ç›‘æ§é…ç½®
    max_memory_restart: '1G',  // å†…å­˜è¶…è¿‡1Gè‡ªåŠ¨é‡å¯
    min_uptime: '10s',  // æœ€å°è¿è¡Œæ—¶é—´
    max_restarts: 10,  // æœ€å¤§é‡å¯æ¬¡æ•°
    
    // æ—¥å¿—
    error_file: './logs/pm2-error.log',
    out_file: './logs/pm2-out.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
    
    // è‡ªåŠ¨é‡å¯
    watch: false,  // ç”Ÿäº§ç¯å¢ƒä¸è¦å¼€å¯
    ignore_watch: ['node_modules', 'logs'],
    
    // ä¼˜é›…é‡å¯
    kill_timeout: 5000,
    listen_timeout: 3000,
  }]
};
```

å¯åŠ¨PM2:

```bash
pm2 start ecosystem.config.js

# æŸ¥çœ‹çŠ¶æ€
pm2 status

# æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
pm2 show audit-backend

# ç›‘æ§é¢æ¿
pm2 monit

# å®æ—¶æ—¥å¿—
pm2 logs audit-backend --lines 100
```

### 2. è‡ªå®šä¹‰å¥åº·æ£€æŸ¥ç«¯ç‚¹

æ‰©å±• `src/routes/systemRoutes.ts`:

```typescript
// è¯¦ç»†å¥åº·æ£€æŸ¥
router.get('/health/detailed', async (req, res) => {
  try {
    const health = {
      status: 'healthy',
      timestamp: new Date().toISOString(),
      uptime: process.uptime(),
      
      // å†…å­˜ä½¿ç”¨
      memory: {
        usage: process.memoryUsage(),
        heapUsed: `${Math.round(process.memoryUsage().heapUsed / 1024 / 1024)}MB`,
        heapTotal: `${Math.round(process.memoryUsage().heapTotal / 1024 / 1024)}MB`,
      },
      
      // CPUä½¿ç”¨
      cpu: {
        usage: process.cpuUsage(),
        average: os.loadavg(),
      },
      
      // æ•°æ®åº“çŠ¶æ€
      database: await checkDatabase(),
      
      // RedisçŠ¶æ€ï¼ˆå¦‚å¯ç”¨ï¼‰
      redis: await checkRedis(),
      
      // å¤–éƒ¨æœåŠ¡çŠ¶æ€
      services: {
        ai: system.getStatus().features.ai.enabled,
        distributed: system.getStatus().features.distributed.enabled,
      },
    };
    
    res.json(health);
  } catch (error) {
    res.status(503).json({
      status: 'unhealthy',
      error: error.message,
    });
  }
});

async function checkDatabase() {
  try {
    await prisma.$queryRaw`SELECT 1`;
    return { status: 'connected', latency: '< 10ms' };
  } catch (error) {
    return { status: 'disconnected', error: error.message };
  }
}

async function checkRedis() {
  // å®ç°Redisæ£€æŸ¥
  return { status: 'not_configured' };
}
```

### 3. æ€§èƒ½æŒ‡æ ‡æ”¶é›†

åˆ›å»º `src/utils/metrics.ts`:

```typescript
import { performance } from 'perf_hooks';

class MetricsCollector {
  private metrics: Map<string, number[]> = new Map();
  
  // è®°å½•æŒ‡æ ‡
  record(name: string, value: number) {
    if (!this.metrics.has(name)) {
      this.metrics.set(name, []);
    }
    this.metrics.get(name)!.push(value);
    
    // åªä¿ç•™æœ€è¿‘1000ä¸ªå€¼
    const values = this.metrics.get(name)!;
    if (values.length > 1000) {
      values.shift();
    }
  }
  
  // è·å–ç»Ÿè®¡
  getStats(name: string) {
    const values = this.metrics.get(name) || [];
    if (values.length === 0) {
      return null;
    }
    
    const sorted = [...values].sort((a, b) => a - b);
    return {
      count: values.length,
      min: Math.min(...values),
      max: Math.max(...values),
      avg: values.reduce((a, b) => a + b, 0) / values.length,
      p50: sorted[Math.floor(sorted.length * 0.5)],
      p95: sorted[Math.floor(sorted.length * 0.95)],
      p99: sorted[Math.floor(sorted.length * 0.99)],
    };
  }
  
  // è·å–æ‰€æœ‰æŒ‡æ ‡
  getAllStats() {
    const stats: Record<string, any> = {};
    for (const [name, _] of this.metrics) {
      stats[name] = this.getStats(name);
    }
    return stats;
  }
}

export const metrics = new MetricsCollector();

// ä¸­é—´ä»¶ï¼šè®°å½•APIå“åº”æ—¶é—´
export function metricsMiddleware(req, res, next) {
  const start = performance.now();
  
  res.on('finish', () => {
    const duration = performance.now() - start;
    metrics.record('api_response_time', duration);
    metrics.record(`api_${req.method}_${req.path}`, duration);
  });
  
  next();
}
```

ä½¿ç”¨æŒ‡æ ‡ï¼š

```typescript
// åœ¨åº”ç”¨ä¸­è®°å½•æŒ‡æ ‡
metrics.record('workflow_execution_time', executionTime);
metrics.record('database_query_time', queryTime);

// è·å–æŒ‡æ ‡ç»Ÿè®¡
const stats = metrics.getStats('api_response_time');
console.log(`P95 response time: ${stats.p95}ms`);
```

---

## âš¡ æ€§èƒ½ç›‘æ§

### 1. Node.jsæ€§èƒ½ç›‘æ§

åˆ›å»º `src/utils/performanceMonitor.ts`:

```typescript
import v8 from 'v8';
import { performance, PerformanceObserver } from 'perf_hooks';

class PerformanceMonitor {
  private observer: PerformanceObserver;
  
  constructor() {
    // ç›‘å¬æ€§èƒ½æŒ‡æ ‡
    this.observer = new PerformanceObserver((items) => {
      items.getEntries().forEach((entry) => {
        logger.debug('Performance Entry', {
          name: entry.name,
          duration: entry.duration,
          type: entry.entryType,
        });
      });
    });
    
    this.observer.observe({ entryTypes: ['measure', 'function'] });
  }
  
  // æµ‹é‡ä»£ç æ‰§è¡Œæ—¶é—´
  async measure<T>(name: string, fn: () => Promise<T>): Promise<T> {
    const mark = `${name}_start`;
    performance.mark(mark);
    
    try {
      const result = await fn();
      performance.measure(name, mark);
      return result;
    } finally {
      performance.clearMarks(mark);
    }
  }
  
  // è·å–ç³»ç»Ÿæ€§èƒ½å¿«ç…§
  getSnapshot() {
    const memUsage = process.memoryUsage();
    const cpuUsage = process.cpuUsage();
    
    return {
      timestamp: new Date().toISOString(),
      uptime: process.uptime(),
      
      memory: {
        rss: `${Math.round(memUsage.rss / 1024 / 1024)}MB`,
        heapUsed: `${Math.round(memUsage.heapUsed / 1024 / 1024)}MB`,
        heapTotal: `${Math.round(memUsage.heapTotal / 1024 / 1024)}MB`,
        external: `${Math.round(memUsage.external / 1024 / 1024)}MB`,
      },
      
      cpu: {
        user: `${Math.round(cpuUsage.user / 1000)}ms`,
        system: `${Math.round(cpuUsage.system / 1000)}ms`,
      },
      
      heap: {
        totalAvailable: v8.getHeapStatistics().total_available_size,
        heapSizeLimit: v8.getHeapStatistics().heap_size_limit,
      },
    };
  }
}

export const perfMonitor = new PerformanceMonitor();
```

ä½¿ç”¨ç¤ºä¾‹ï¼š

```typescript
// æµ‹é‡å‡½æ•°æ‰§è¡Œæ—¶é—´
const result = await perfMonitor.measure('fetch_workflows', async () => {
  return await prisma.workflow.findMany();
});

// è·å–æ€§èƒ½å¿«ç…§
const snapshot = perfMonitor.getSnapshot();
logger.info('Performance Snapshot', snapshot);
```

### 2. æ•°æ®åº“æŸ¥è¯¢ç›‘æ§

åœ¨Prismaä¸­å¯ç”¨æ—¥å¿—ï¼š

```typescript
// prisma/client.ts
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient({
  log: [
    { level: 'query', emit: 'event' },
    { level: 'error', emit: 'stdout' },
    { level: 'warn', emit: 'stdout' },
  ],
});

// ç›‘å¬æŸ¥è¯¢äº‹ä»¶
prisma.$on('query', (e) => {
  if (e.duration > 100) {  // æ…¢æŸ¥è¯¢ > 100ms
    logger.warn('Slow Query Detected', {
      query: e.query,
      params: e.params,
      duration: `${e.duration}ms`,
    });
  }
});

export default prisma;
```

---

## ğŸ”” å‘Šè­¦é…ç½®

### 1. é”™è¯¯å‘Šè­¦

åˆ›å»º `src/utils/alerting.ts`:

```typescript
import logger from '../config/logger';
import nodemailer from 'nodemailer';

class AlertingSystem {
  private transporter: nodemailer.Transporter;
  
  constructor() {
    // é…ç½®é‚®ä»¶å‘é€
    this.transporter = nodemailer.createTransporter({
      host: process.env.SMTP_HOST,
      port: parseInt(process.env.SMTP_PORT || '587'),
      secure: false,
      auth: {
        user: process.env.SMTP_USER,
        pass: process.env.SMTP_PASS,
      },
    });
  }
  
  // å‘é€å‘Šè­¦
  async sendAlert(level: 'critical' | 'warning' | 'info', message: string, details?: any) {
    const alert = {
      level,
      message,
      details,
      timestamp: new Date().toISOString(),
      hostname: process.env.HOSTNAME || 'unknown',
    };
    
    logger.error('ALERT', alert);
    
    // å‘é€é‚®ä»¶
    if (level === 'critical') {
      await this.sendEmail(alert);
    }
    
    // å‘é€åˆ°ä¼ä¸šå¾®ä¿¡/é’‰é’‰ï¼ˆå¯é€‰ï¼‰
    // await this.sendToWeChat(alert);
  }
  
  private async sendEmail(alert: any) {
    try {
      await this.transporter.sendMail({
        from: process.env.ALERT_FROM,
        to: process.env.ALERT_TO,
        subject: `[${alert.level.toUpperCase()}] ${alert.message}`,
        html: `
          <h2>ç³»ç»Ÿå‘Šè­¦</h2>
          <p><strong>çº§åˆ«:</strong> ${alert.level}</p>
          <p><strong>æ¶ˆæ¯:</strong> ${alert.message}</p>
          <p><strong>æ—¶é—´:</strong> ${alert.timestamp}</p>
          <p><strong>ä¸»æœº:</strong> ${alert.hostname}</p>
          <pre>${JSON.stringify(alert.details, null, 2)}</pre>
        `,
      });
    } catch (error) {
      logger.error('Failed to send alert email', error);
    }
  }
}

export const alerting = new AlertingSystem();
```

### 2. å‘Šè­¦è§„åˆ™

åˆ›å»º `src/utils/alertRules.ts`:

```typescript
import { alerting } from './alerting';
import { perfMonitor } from './performanceMonitor';

// å®šæ—¶æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
setInterval(() => {
  const snapshot = perfMonitor.getSnapshot();
  
  // å†…å­˜å‘Šè­¦
  const heapUsed = parseInt(snapshot.memory.heapUsed);
  if (heapUsed > 800) {  // > 800MB
    alerting.sendAlert('warning', 'High memory usage', { heapUsed });
  }
  if (heapUsed > 1000) {  // > 1GB
    alerting.sendAlert('critical', 'Critical memory usage', { heapUsed });
  }
  
  // CPUå‘Šè­¦
  const cpuUser = parseInt(snapshot.cpu.user);
  if (cpuUser > 10000) {  // > 10s
    alerting.sendAlert('warning', 'High CPU usage', { cpuUser });
  }
  
}, 60000);  // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡

// é”™è¯¯ç‡å‘Šè­¦
let errorCount = 0;
let requestCount = 0;

export function trackRequest(isError: boolean) {
  requestCount++;
  if (isError) errorCount++;
  
  // æ¯100ä¸ªè¯·æ±‚æ£€æŸ¥ä¸€æ¬¡
  if (requestCount % 100 === 0) {
    const errorRate = (errorCount / requestCount) * 100;
    if (errorRate > 5) {
      alerting.sendAlert('warning', 'High error rate', {
        errorRate: `${errorRate.toFixed(2)}%`,
        errors: errorCount,
        requests: requestCount,
      });
    }
    
    // é‡ç½®è®¡æ•°å™¨
    errorCount = 0;
    requestCount = 0;
  }
}
```

---

## ğŸš€ å®æ–½æ­¥éª¤

### Step 1: å®‰è£…ä¾èµ–

```bash
npm install winston winston-daily-rotate-file nodemailer
npm install --save-dev @types/nodemailer
```

### Step 2: åˆ›å»ºæ—¥å¿—ç›®å½•

```bash
mkdir -p logs
echo "logs/" >> .gitignore
```

### Step 3: é›†æˆåˆ°åº”ç”¨

åœ¨ `src/index.v2.ts` ä¸­:

```typescript
import logger from './config/logger';
import { httpLogger } from './middleware/httpLogger';
import { errorLogger } from './middleware/errorLogger';
import { metricsMiddleware } from './utils/metrics';

// ä½¿ç”¨ä¸­é—´ä»¶
app.use(httpLogger);
app.use(metricsMiddleware);

// é”™è¯¯å¤„ç†
app.use(errorLogger);

// å¯åŠ¨æ—¥å¿—
logger.info('Application starting', {
  env: process.env.NODE_ENV,
  port: process.env.PORT,
  version: '2.0.0',
});
```

### Step 4: é…ç½®ç¯å¢ƒå˜é‡

åœ¨ `.env` æ·»åŠ :

```env
# æ—¥å¿—é…ç½®
LOG_LEVEL=info

# å‘Šè­¦é‚®ä»¶é…ç½®
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_USER=alerts@example.com
SMTP_PASS=your_password
ALERT_FROM=alerts@example.com
ALERT_TO=admin@example.com
```

### Step 5: å¯åŠ¨åº”ç”¨

```bash
# ä½¿ç”¨PM2å¯åŠ¨
pm2 start ecosystem.config.js

# æŸ¥çœ‹æ—¥å¿—
pm2 logs audit-backend

# æŸ¥çœ‹ç›‘æ§
pm2 monit
```

### Step 6: éªŒè¯ç›‘æ§

```bash
# æŸ¥çœ‹å¥åº·çŠ¶æ€
curl http://localhost:3000/api/system/health/detailed

# æŸ¥çœ‹æ€§èƒ½æŒ‡æ ‡
curl http://localhost:3000/api/system/metrics
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ç”Ÿäº§éƒ¨ç½²æ£€æŸ¥æ¸…å•](../ç”Ÿäº§éƒ¨ç½²æ£€æŸ¥æ¸…å•.md)
- [æ•…éšœæ’æŸ¥æ‰‹å†Œ](../æ•…éšœæ’æŸ¥æ‰‹å†Œ.md)
- [å¿«é€Ÿå¯åŠ¨æŒ‡å—](../å¿«é€Ÿå¯åŠ¨æŒ‡å—.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0  
**æœ€åæ›´æ–°**: 2025å¹´1æœˆ4æ—¥  
**ç»´æŠ¤å›¢é˜Ÿ**: SHENJI Team
