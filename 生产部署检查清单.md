# 生产部署检查清单

**审计数智析 V2.0 - Production Deployment Checklist**

📅 **创建日期**: 2025年1月4日  
🎯 **目标**: 确保生产环境部署顺利、安全、可靠

---

## 📋 使用说明

- [ ] 部署前：逐项检查并勾选
- [ ] 部署中：按步骤执行
- [ ] 部署后：验证所有功能
- [ ] 记录：填写实际值和问题

---

## 🔍 部署前检查 (Pre-Deployment)

### 环境准备

- [ ] **服务器准备**
  - [ ] CPU: >= 4核
  - [ ] 内存: >= 8GB
  - [ ] 磁盘: >= 100GB可用空间
  - [ ] 操作系统: Ubuntu 20.04+ / CentOS 8+
  - [ ] 网络: 稳定的互联网连接

- [ ] **软件依赖**
  - [ ] Node.js: v18.x 或更高版本
  - [ ] npm: v9.x 或更高版本
  - [ ] PostgreSQL: v14+ (已安装并运行)
  - [ ] Redis: v6+ (可选，用于分布式功能)
  - [ ] Git: v2.x+

- [ ] **端口可用性**
  - [ ] 3000 (后端API)
  - [ ] 5432 (PostgreSQL)
  - [ ] 6379 (Redis，如启用)
  - [ ] 5173 (前端开发，可选)

### 代码准备

- [ ] **版本控制**
  - [ ] Git仓库克隆完成
  - [ ] 切换到正确的分支/标签: `master` / `v2.0.0`
  - [ ] 代码完整性验证: `git status` 无未提交修改

- [ ] **依赖安装**
  ```bash
  # 后端依赖
  cd packages/backend
  npm install
  
  # 前端依赖（如需要）
  cd ../frontend
  npm install
  ```
  - [ ] 后端依赖安装成功
  - [ ] 前端依赖安装成功（如适用）
  - [ ] 无安装错误或警告

### 配置文件

- [ ] **环境变量配置** (`.env`)
  
  **基础配置**:
  - [ ] `NODE_ENV=production`
  - [ ] `PORT=3000`
  - [ ] `DATABASE_URL` 配置正确
  - [ ] `JWT_SECRET` 已设置（强密钥）
  - [ ] `CORS_ORIGIN` 配置正确
  
  **功能开关**:
  - [ ] `PLUGIN_ENABLED` (推荐: true)
  - [ ] `RBAC_ENABLED` (推荐: true)
  - [ ] `AUDIT_ENABLED` (推荐: true)
  - [ ] `AI_ENABLED` (可选)
  - [ ] `DISTRIBUTED_ENABLED` (可选)
  
  **外部服务** (如启用):
  - [ ] `REDIS_URL` (如启用分布式)
  - [ ] `OPENAI_API_KEY` (如启用AI)
  
  **安全配置**:
  - [ ] `SESSION_SECRET` 已设置
  - [ ] `BCRYPT_ROUNDS` (推荐: 10)

- [ ] **数据库配置**
  - [ ] 数据库已创建
  - [ ] 数据库用户权限正确
  - [ ] 连接字符串测试通过

### 安全检查

- [ ] **密钥和凭证**
  - [ ] 所有密钥都是强随机生成
  - [ ] 生产环境密钥不同于开发环境
  - [ ] `.env` 文件不在版本控制中
  - [ ] 敏感信息不在代码中硬编码

- [ ] **访问控制**
  - [ ] 防火墙规则已配置
  - [ ] 仅必要端口对外开放
  - [ ] SSH密钥认证已启用
  - [ ] 定期安全更新计划已制定

---

## 🚀 部署执行 (Deployment)

### 数据库迁移

- [ ] **备份现有数据** (如有)
  ```bash
  pg_dump -U postgres -d audit_db > backup_$(date +%Y%m%d_%H%M%S).sql
  ```
  - [ ] 备份文件位置: ___________________
  - [ ] 备份文件大小: ___________________

- [ ] **执行数据库迁移**
  ```bash
  cd packages/backend
  npm run prisma:migrate
  ```
  - [ ] 迁移成功
  - [ ] 无错误或警告

- [ ] **生成Prisma Client**
  ```bash
  npm run prisma:generate
  ```
  - [ ] 生成成功

- [ ] **种子数据** (可选)
  ```bash
  npm run prisma:seed
  ```
  - [ ] 执行成功（如需要）

### 应用构建

- [ ] **后端构建**
  ```bash
  cd packages/backend
  npm run build
  ```
  - [ ] 构建成功
  - [ ] `dist/` 目录已生成
  - [ ] 无TypeScript错误

- [ ] **前端构建** (如适用)
  ```bash
  cd packages/frontend
  npm run build
  ```
  - [ ] 构建成功
  - [ ] `dist/` 目录已生成

### 应用启动

- [ ] **测试启动** (先测试，不要作为服务)
  ```bash
  # V2版本（推荐）
  cd packages/backend
  npm run start:v2
  
  # 或V1版本
  npm run start
  ```
  - [ ] 启动成功
  - [ ] 无致命错误
  - [ ] 所有模块初始化成功

- [ ] **进程管理** (推荐使用PM2)
  ```bash
  # 安装PM2
  npm install -g pm2
  
  # 启动应用
  pm2 start npm --name "audit-backend" -- run start:v2
  
  # 设置开机自启
  pm2 startup
  pm2 save
  ```
  - [ ] PM2已安装
  - [ ] 应用已启动
  - [ ] 开机自启已配置

---

## ✅ 部署后验证 (Post-Deployment)

### 健康检查

- [ ] **API健康检查**
  ```bash
  curl http://localhost:3000/api/system/health
  ```
  - [ ] 返回状态: `200 OK`
  - [ ] 响应内容: `{"status":"healthy"}`

- [ ] **系统状态检查**
  ```bash
  curl http://localhost:3000/api/system/status \
    -H "Authorization: Bearer <token>"
  ```
  - [ ] 所有功能状态正常
  - [ ] 性能指标合理

### 功能验证

- [ ] **认证功能**
  - [ ] 用户登录成功
  - [ ] Token生成和验证正常
  - [ ] 会话管理正常

- [ ] **核心功能**
  - [ ] 节点注册和查询
  - [ ] 工作流创建和执行
  - [ ] 任务调度正常

- [ ] **高级功能** (如启用)
  - [ ] 插件系统工作正常
  - [ ] 权限控制生效
  - [ ] 审计日志记录正常
  - [ ] AI分析可用（如启用）
  - [ ] 分布式执行正常（如启用）

### 性能验证

- [ ] **响应时间**
  - [ ] API平均响应时间 < 100ms
  - [ ] 数据库查询时间 < 50ms
  - [ ] 工作流执行时间合理

- [ ] **资源使用**
  - [ ] CPU使用率 < 50%（空闲时）
  - [ ] 内存使用 < 4GB（初始）
  - [ ] 磁盘空间充足

- [ ] **并发测试**
  - [ ] 100并发请求正常处理
  - [ ] 无超时或错误

### 日志检查

- [ ] **应用日志**
  ```bash
  pm2 logs audit-backend
  ```
  - [ ] 无ERROR级别日志
  - [ ] WARN日志已查看并确认

- [ ] **系统日志**
  - [ ] PostgreSQL日志正常
  - [ ] Redis日志正常（如使用）
  - [ ] Nginx日志正常（如使用）

---

## 🔐 安全加固 (Security Hardening)

### SSL/TLS配置

- [ ] **HTTPS启用**
  - [ ] SSL证书已安装
  - [ ] HTTP自动跳转HTTPS
  - [ ] 证书有效期检查

- [ ] **Nginx反向代理** (推荐)
  ```nginx
  server {
      listen 80;
      server_name your-domain.com;
      return 301 https://$server_name$request_uri;
  }
  
  server {
      listen 443 ssl http2;
      server_name your-domain.com;
      
      ssl_certificate /path/to/cert.pem;
      ssl_certificate_key /path/to/key.pem;
      
      location / {
          proxy_pass http://localhost:3000;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
      }
  }
  ```
  - [ ] Nginx已配置
  - [ ] SSL配置正确
  - [ ] 反向代理工作正常

### 访问控制

- [ ] **CORS配置**
  - [ ] 仅允许受信任的源
  - [ ] 凭证传递配置正确

- [ ] **Rate Limiting**
  - [ ] API限流已启用
  - [ ] 限流规则合理

- [ ] **输入验证**
  - [ ] 所有API端点有输入验证
  - [ ] SQL注入防护
  - [ ] XSS防护

---

## 📊 监控和告警 (Monitoring)

### 应用监控

- [ ] **PM2监控**
  ```bash
  pm2 monit
  ```
  - [ ] CPU和内存监控可见
  - [ ] 进程状态正常

- [ ] **日志监控**
  - [ ] 错误日志告警已配置
  - [ ] 日志轮转已配置
  - [ ] 日志保留策略已设置

### 系统监控

- [ ] **资源监控**
  - [ ] CPU使用率监控
  - [ ] 内存使用监控
  - [ ] 磁盘空间监控
  - [ ] 网络流量监控

- [ ] **数据库监控**
  - [ ] 连接数监控
  - [ ] 慢查询日志
  - [ ] 数据库大小监控

### 告警配置

- [ ] **告警规则**
  - [ ] CPU > 80% 持续5分钟
  - [ ] 内存 > 90%
  - [ ] 磁盘空间 < 10GB
  - [ ] 应用崩溃/重启
  - [ ] API错误率 > 5%

- [ ] **告警渠道**
  - [ ] 邮件告警
  - [ ] 短信告警（可选）
  - [ ] 企业微信/钉钉（可选）

---

## 🔄 备份策略 (Backup)

### 数据库备份

- [ ] **自动备份脚本**
  ```bash
  #!/bin/bash
  # /opt/scripts/backup_db.sh
  
  BACKUP_DIR="/opt/backups/database"
  DATE=$(date +%Y%m%d_%H%M%S)
  
  pg_dump -U postgres -d audit_db | gzip > \
    $BACKUP_DIR/backup_$DATE.sql.gz
  
  # 保留最近30天的备份
  find $BACKUP_DIR -type f -mtime +30 -delete
  ```
  - [ ] 脚本已创建
  - [ ] 执行权限已设置

- [ ] **定时任务**
  ```bash
  # 添加到crontab
  0 2 * * * /opt/scripts/backup_db.sh
  ```
  - [ ] Cron任务已配置
  - [ ] 每日2点执行备份

- [ ] **备份验证**
  - [ ] 备份文件可读
  - [ ] 恢复测试成功

### 配置文件备份

- [ ] **配置备份**
  - [ ] `.env` 文件已备份（安全存储）
  - [ ] Nginx配置已备份
  - [ ] PM2配置已备份

---

## 📝 文档和交接 (Documentation)

### 部署文档

- [ ] **部署记录**
  - [ ] 部署日期: ___________________
  - [ ] 部署版本: v2.0.0
  - [ ] 部署人员: ___________________
  - [ ] 服务器信息: ___________________

- [ ] **配置记录**
  - [ ] 环境变量清单
  - [ ] 启用的功能列表
  - [ ] 外部服务配置

### 运维文档

- [ ] **访问信息**
  - [ ] API端点: https://___________________
  - [ ] 管理员账号: ___________________
  - [ ] 数据库连接: ___________________

- [ ] **联系人信息**
  - [ ] 技术负责人: ___________________
  - [ ] 运维负责人: ___________________
  - [ ] 紧急联系人: ___________________

---

## 🎯 验收标准 (Acceptance Criteria)

### 功能性

- [ ] 所有核心功能正常工作
- [ ] 所有启用的高级功能正常工作
- [ ] 用户可以正常登录和操作

### 性能

- [ ] API响应时间 < 100ms (P95)
- [ ] 并发100用户无性能问题
- [ ] 资源使用在合理范围

### 可靠性

- [ ] 7x24小时稳定运行
- [ ] 无未处理的ERROR日志
- [ ] 数据备份正常

### 安全性

- [ ] HTTPS已启用
- [ ] 所有安全检查项通过
- [ ] 无已知安全漏洞

---

## ⚠️ 回滚计划 (Rollback Plan)

### 回滚条件

如出现以下情况，执行回滚：
- [ ] 核心功能完全不可用
- [ ] 数据丢失或损坏
- [ ] 严重性能问题
- [ ] 严重安全漏洞

### 回滚步骤

1. **停止当前应用**
   ```bash
   pm2 stop audit-backend
   ```

2. **恢复数据库** (如有备份)
   ```bash
   psql -U postgres -d audit_db < backup_YYYYMMDD_HHMMSS.sql
   ```

3. **切换到旧版本**
   ```bash
   git checkout <previous-version>
   npm install
   npm run build
   ```

4. **重启应用**
   ```bash
   pm2 restart audit-backend
   ```

5. **验证回滚**
   - [ ] 应用正常运行
   - [ ] 数据完整性检查
   - [ ] 功能验证

---

## 📋 部署后任务 (Post-Deployment Tasks)

### 第1天

- [ ] 密切监控应用日志
- [ ] 检查资源使用情况
- [ ] 响应用户反馈
- [ ] 记录所有问题

### 第1周

- [ ] 性能数据收集和分析
- [ ] 用户反馈整理
- [ ] 优化配置（如需要）
- [ ] 更新文档

### 第1个月

- [ ] 全面性能评估
- [ ] 安全审计
- [ ] 备份恢复演练
- [ ] 制定长期运维计划

---

## ✅ 最终签字确认

**部署负责人**: ___________________  
**签字**: ___________________  
**日期**: ___________________

**技术负责人**: ___________________  
**签字**: ___________________  
**日期**: ___________________

**项目经理**: ___________________  
**签字**: ___________________  
**日期**: ___________________

---

## 📞 紧急联系

**技术支持**: ___________________  
**运维团队**: ___________________  
**24小时热线**: ___________________

---

**文档版本**: 1.0.0  
**最后更新**: 2025年1月4日  
**维护团队**: SHENJI Team
